---
title: "Single species 60 year simulation analysis"
output: pdf_document
fig_height: 2
fig_width: 4
---
```{r, message=FALSE, warning=FALSE}
library(tidyverse);
library(stringr);
library(viridis);
library(gridExtra);
```

# Single species, 5mÂ² area (Achillea millefolium)

## Standard procedures
Set outputs folder, specific ID and get file
```{r, include=FALSE}
## CHANGE file name:
inid <- file.path("species.csv") # check in simID file in output
outid <- file.path("singlesp1-60y"); #simID
## Paths:
# Inputs
#indir <- file.path("/home/ludmilla/Documents/uni_wuerzburg/phd_project/thesis/model/inputs") #Thinkpad
indir <- file.path("/home/luf74xx/Dokumente/model/inputs"); #CCTBserver
input <- as_tibble(read.table(file.path(indir, inid), header = TRUE, sep = ","))
# Outputs:
#outdir <- file.path("/home/ludmilla/Documents/uni_wuerzburg/phd_project/thesis/model/EDoutputs") #Thinkpad
outdir <- file.path("/home/luf74xx/Dokumente/model/EDoutputs"); #CCTBserver
outraw <- as_tibble(read.table(file.path(outdir, outid, "orgsweekly.csv"), header = TRUE, sep = "\t"));

# Clean raw data

## Take parentheses out of location column ("()")
loc <- gsub("[\\(|\\)]", "", outraw$location)
 ## split location in 3 columns
loc <- as.data.frame(matrix(unlist(str_split(loc, ",")),ncol =3,byrow = T))
names(loc) = c("xloc", "yloc", "floc")

## Complete and clean table
outdata <- as_tibble(cbind(select(outraw,-one_of("location")),
                 loc))
rm(loc)
```

### Reproduction
Because the focus of the population is to verify population stability, we start its analysis with this instead of the usual biomass accumulation.

1. Check if reproduction is happening
```{r}
levels(outdata$mated)
```

2. Plot populations, weekly
```{r Fig1, echo = TRUE, fig.height = 10, fig.width = 15}
weekabund <- outdata %>% group_by(week, sp) %>% summarize(abundance = n())

weekabund.plot <- ggplot(weekabund, aes(x = week, y = abundance, color = factor(sp))) 
weekabund.plot +
  geom_line() + #TODO differentiate species with colorgeom_line(color = "forestgreen") 
  labs(x = "Week", y = "Abundance (n individuals)",
       title = "Abundance variation",
       subtitle = "Species abundance per week")+
  theme_minimal()+
  theme(legend.position = "none")
```
There is population growth and some kind of "base" stability, where population growth is not so pronounced anymore ( after week ~ 1000).
Annual mortality peaks every year, right after a pick in population growth. This could be population dynamics, but the fact that population declines drasticatlly after week 2500 suggest that all adults are actually dying, since the maximum life span of the spp is 50 years (2600 weeks). Therefore, the annual peaks of population growth seem to be a result of reproductive output, and the the mortality peaks that immediately follow, a result of high juvenile mortality.

Verify it:

1. Population structure
```{r}
weekstruct <- outdata %>% group_by(week, sp, stage) %>% summarize(abundance = n())
weekstruct.plot <- ggplot(weekstruct, aes(x = week, y = abundance, color = factor(stage))) +
  geom_line()
```

Whole simulation
```{r Fig2, echo = TRUE, fig.height = 10, fig.width = 15}
weekstruct.plot+
  labs(x = "Abundance", 
       y = "Week",
       title = "Population structure")+
  scale_color_discrete("Stages:", labels = c("Adults", "Seeds", "Juveniles"))+
  theme_minimal()
```
Most seeds (**e**) are dying within the same year they are produced. Therefore, there is *no seed bank formation*.
Juveniles are the ones dominating population dynamics, including death after 50 years (week 2600). If they are juveniles, they should be replacing the adults and the population should not decrease so drastically after 50 years. However, this is not happening, since the number of adults does not change, n = 20. 
It is possible that the juveniles are getting at the age of 50 years without ever becoming adults. This generates the following:
+ they start dying after 50 years: the olders go first, and then the younger (the rates of decline might even be similar to growth.)
+ they are not growing enough the achieve theminimal adult biomass
+ where do the two increases in seed production come from? 

Detailed look at the first 5 years:

```{r Fig3, echo = TRUE, fig.height = 7, fig.width = 15}
weekstruct.plot + xlim(c(1,260))+
  geom_point()+
  labs(x = "Abundance", 
       y = "Week",
       title = "Population structure 1917 - 1922")+
  scale_color_discrete("Stages:", labels = c("Adults", "Seeds", "Juveniles"))+
  theme_minimal()
```

```{r Fig4, echo = TRUE, fig.height = 9, fig.width = 15}
oneyr <- weekstruct.plot + xlim(c(1,52))+
  geom_point()+
  labs(x = "Abundance", 
       y = "Week",
       title = "Population structure 1917")+
  scale_color_discrete("Stages:", labels = c("Adults", "Seeds", "Juveniles"))+
  theme_minimal()+
  theme(legend.position = "bottom")

twoyr <- weekstruct.plot + xlim(c(1,104))+
  geom_point()+
  labs(x = "Abundance", 
       y = "Week",
       title = "Population structure 1917 - 1922")+
  scale_color_discrete("Stages:", labels = c("Adults", "Seeds", "Juveniles"))+
  theme_minimal()+
  theme(legend.position = "none")

grid.arrange(oneyr, twoyr, nrow = 1)
```

The seeds are *germinating* and replacing the juveniles. The problem seems to be the juveniles *growing* and replacing the adults.

Biomass growth seems to be a bigger issue.

###Growth

1. Plot individual vegetative biomass, weekly
2. Get species-specific biomass mean and variation weekly

Check individual variation
```{r Fig5, echo = TRUE, fig.height = 5, fig.width = 15}
biomass <- outdata %>%
  select(week,id,stage,sp,veg,repr)

#Individual juvenile biomass variation
indweekmass.plot <- ggplot(filter(biomass, stage == "j"), aes(x=week, y= veg, color = factor(id)))
indweekmass.plot +
  geom_line() +
  labs(x = "Week", y = "Individual vegetative biomass (g)",
       title = "Juvenile weekly weight")+
  theme_minimal()+
  theme(legend.position = "none")
```
Growth is increasing exponentially(?) with time, but it should be achieving adult biomass much faster.
Currently, MTE growth constant at 6.7026e8. Set it to 6.7026e10 and check results.